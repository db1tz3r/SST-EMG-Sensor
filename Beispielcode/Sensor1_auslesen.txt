using System;
using CyUSB;
using Waveplus.DaqSys;
using Waveplus.DaqSysInterface;

class Program
{
    static void Main(string[] args)
    {
        try
        {
            // Initialisiere das DaqSystem
            DaqSystem daqSystem = new DaqSystem();
            Console.WriteLine("DaqSystem initialisiert.");

            // Überprüfe, ob das Gerät verbunden ist
            USBDeviceList usbDevices = new USBDeviceList(CyConst.DEVICES_CYUSB);
            CyUSBDevice myDevice = usbDevices[0x04B4, 0x1002] as CyUSBDevice;

            if (myDevice != null)
            {
                Console.WriteLine("Gerät gefunden.");
            }
            else
            {
                Console.WriteLine("Kein Gerät gefunden.");
            }


            // Aktiviere Sensor 1
            int sensorId = 1;
            int installedSensors = daqSystem.InstalledSensors;
            if (sensorId <= installedSensors)
            {
                daqSystem.EnableSensor(sensorId);
                Console.WriteLine($"Sensor {sensorId} aktiviert.");
            }
            else
            {
                Console.WriteLine("Sensor 1 ist nicht installiert.");
                return;
            }

            // Konfiguriere die Datenerfassung
            ICaptureConfiguration captureConfig = new CaptureConfiguration
            {
                SamplingRate = SamplingRate.Hz_2000, // Beispiel: 2000 Hz
                ExternalTriggerEnabled = false // Kein externes Triggern
            };
            daqSystem.ConfigureCapture(captureConfig);
            Console.WriteLine("Datenerfassung konfiguriert.");

            // Starte die Datenerfassung
            daqSystem.StartCapturing(DataAvailableEventPeriod.ms_100);
            Console.WriteLine("Datenerfassung gestartet.");

            // Event-Handler, um Daten anzuzeigen, wenn sie verfügbar sind
            daqSystem.DataAvailable += (sender, e) =>
            {
                Console.WriteLine($"Daten empfangen. Anzahl Samples: {e.Samples.GetLength(1)}");
                for (int i = 0; i < Math.Min(10, e.Samples.GetLength(1)); i++)  // Zeigt die ersten 10 Samples an
                {
                    Console.WriteLine($"Sensor 1 - Sample {i + 1}: {e.Samples[0, i]} µV");
                }
            };

            // Warten, bis der Benutzer das Programm stoppt
            Console.WriteLine("Drücke die Eingabetaste, um die Datenerfassung zu stoppen.");
            Console.ReadLine();

            // Stoppe die Datenerfassung
            daqSystem.StopCapturing();
            Console.WriteLine("Datenerfassung gestoppt.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fehler: {ex.Message}");
        }
    }
}